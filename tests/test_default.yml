# This is an example playbook to execute goss tests.
# Tests need distributed to the appropriate ansible host/groups
# prior to execution by `goss validate`.
#
# The goss ansible module is installed with molecule.  The ANSIBLE_LIBRARY
# path is updated appropriately on `molecule verify`.

- name: Testing prerequisites
  hosts: all
  gather_facts: yes
  tasks:
    - name: Install ca-certificates
      apt: name=ca-certificates
      when: ansible_os_family == 'Debian'
    - name: Download and install goss
      get_url: url=https://github.com/aelsabbahy/goss/releases/download/v0.2.3/goss-linux-amd64
               dest=/usr/local/bin/goss
               sha256sum=3529ee6c68888a3c296dca1a3ff9c235c2fed4c641e3a25b44f231cd8ac0025f.
               mode=0755

    - name: Copy tests to remote
      copy: src="../../files/goss/{{ item }}"
            dest="/tmp/{{ item }}"
      with_items:
        - hosts.yml

- name: Execute goss tests
  hosts: all
  gather_facts: no
  tasks:
    - name: test goss files
      goss: path="/tmp/{{ item }}"
            format=documentation
      with_items:
        - hosts.yml